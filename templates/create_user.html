{% extends "base.html" %}

{% block title %}Cr√©er un Utilisateur - Cabinet M√©dical{% endblock %}

{% block content %}
<div class="content-container">
    <div class="page-header">
        <h1>‚ûï Cr√©er un Nouvel Utilisateur</h1>
        <a href="{{ url_for('admin_panel') }}" class="btn btn-secondary">‚Üê Retour</a>
    </div>
    
    <div class="form-container">
        <form method="POST" action="{{ url_for('create_user') }}" id="createUserForm">
            <div class="form-group">
                <label for="username">üë§ Nom d'utilisateur *</label>
                <input type="text" id="username" name="username" required autofocus>
            </div>
            
            <div class="form-group">
                <label for="password">üîë Mot de passe *</label>
                <input type="password" id="password" name="password" required minlength="8">
                <small>Minimum 8 caract√®res (s√©curit√© renforc√©e)</small>
            </div>
            
            <div class="form-group">
                <label for="role">üé≠ R√¥le *</label>
                <select id="role" name="role" required class="form-select" onchange="togglePatientFields()">
                    {% for role in available_roles %}
                    <option value="{{ role }}">
                        {{ Role.get_role_name(role) }}
                        {% if role == 'user' %}(Par d√©faut){% endif %}
                    </option>
                    {% endfor %}
                </select>
                <small>
                    {% if user_role == 'admin' %}
                    ‚ö†Ô∏è En tant qu'administrateur, vous ne pouvez cr√©er que des utilisateurs normaux.
                    {% else %}
                    ‚ÑπÔ∏è Choisissez le niveau d'acc√®s appropri√©.
                    {% endif %}
                </small>
            </div>
            
            <!-- Section Patient (visible uniquement pour le r√¥le USER) -->
            <div id="patientSection" style="display: block;">
                <hr style="margin: 30px 0;">
                <h3>üè• Informations du Patient</h3>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <strong>‚ö†Ô∏è R√®gle Importante:</strong> Pour cr√©er un compte utilisateur normal, le patient doit d√©j√† √™tre enregistr√© dans le syst√®me.
                    <br><small>Les informations ci-dessous doivent correspondre exactement √† un patient existant.</small>
                </div>
                
                <div class="form-group">
                    <label for="patient_selector">S√©lectionner un patient existant:</label>
                    <select id="patient_selector" class="form-select" onchange="fillPatientInfo()">
                        <option value="">-- S√©lectionner un patient --</option>
                        {% for patient in patients %}
                        <option value="{{ patient.nom }}|{{ patient.email }}|{{ patient.telephone }}">
                            {{ patient.nom }} ({{ patient.email }})
                        </option>
                        {% endfor %}
                    </select>
                    <small>Ou remplissez les champs manuellement ci-dessous</small>
                </div>
                
                <div class="form-group">
                    <label for="patient_nom">üë§ Nom du Patient *</label>
                    <input type="text" id="patient_nom" name="patient_nom" class="patient-field">
                    <small>Doit correspondre exactement au nom dans le syst√®me</small>
                </div>
                
                <div class="form-group">
                    <label for="patient_email">üìß Email du Patient *</label>
                    <input type="email" id="patient_email" name="patient_email" class="patient-field">
                    <small>Doit correspondre exactement √† l'email dans le syst√®me</small>
                </div>
                
                <div class="form-group">
                    <label for="patient_telephone">üì± T√©l√©phone du Patient *</label>
                    <input type="tel" id="patient_telephone" name="patient_telephone" class="patient-field">
                    <small>Doit correspondre exactement au t√©l√©phone dans le syst√®me</small>
                </div>
            </div>
            
            <div class="role-description">
                <h3>Description des r√¥les:</h3>
                <ul>
                    <li><strong>üë§ Utilisateur:</strong> Peut g√©rer ses propres contacts (patients) uniquement. Doit √™tre associ√© √† un patient existant.</li>
                    <li><strong>üëÆ Administrateur:</strong> Peut cr√©er des utilisateurs, g√©rer tous les patients, envoyer des communications group√©es</li>
                    <li><strong>‚ö° Super Administrateur:</strong> Contr√¥le total sur l'application et la base de donn√©es</li>
                </ul>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-success">‚úì Cr√©er l'utilisateur</button>
                <a href="{{ url_for('admin_panel') }}" class="btn btn-secondary">‚úó Annuler</a>
            </div>
        </form>
    </div>
</div>

<script>
function togglePatientFields() {
    var role = document.getElementById('role').value;
    var patientSection = document.getElementById('patientSection');
    var patientFields = document.querySelectorAll('.patient-field');
    
    if (role === 'user') {
        patientSection.style.display = 'block';
        // Rendre les champs obligatoires
        patientFields.forEach(function(field) {
            field.required = true;
        });
    } else {
        patientSection.style.display = 'none';
        // Rendre les champs optionnels
        patientFields.forEach(function(field) {
            field.required = false;
            field.value = '';
        });
        document.getElementById('patient_selector').value = '';
    }
}

function fillPatientInfo() {
    var selector = document.getElementById('patient_selector');
    var selectedValue = selector.value;
    
    if (selectedValue) {
        var parts = selectedValue.split('|');
        if (parts.length === 3) {
            document.getElementById('patient_nom').value = parts[0];
            document.getElementById('patient_email').value = parts[1];
            document.getElementById('patient_telephone').value = parts[2];
        }
    } else {
        document.getElementById('patient_nom').value = '';
        document.getElementById('patient_email').value = '';
        document.getElementById('patient_telephone').value = '';
    }
}

// Initialiser l'affichage au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    togglePatientFields();
});
</script>
{% endblock %}
