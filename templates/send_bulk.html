{% extends "base.html" %}

{% block title %}Envoi Group√© - Cabinet M√©dical{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üì§ Envoi Group√©</h1>
        <p>Envoyer des communications √† plusieurs patients (Admin/Super Admin uniquement)</p>
    </div>

    <div class="actions">
        <a href="{{ url_for('communications') }}" class="btn">‚Üê Retour</a>
    </div>

    <div class="form-container">
        <form method="POST" id="bulkForm">
            <!-- Type de communication -->
            <div class="form-group">
                <label for="type">Type de communication: *</label>
                <select name="type" id="type" required onchange="updateForm()">
                    <option value="">-- S√©lectionner --</option>
                    <option value="email">üìß Email</option>
                    <option value="whatsapp">üí¨ WhatsApp</option>
                </select>
            </div>

            <!-- S√©lection des contacts -->
            <div class="form-group">
                <label>S√©lectionner les patients: *</label>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                    <div style="margin-bottom: 10px;">
                        <label>
                            <input type="checkbox" id="selectAll" onchange="toggleAllContacts()">
                            <strong>Tout s√©lectionner ({{ contacts|length }} patients)</strong>
                        </label>
                    </div>
                    <hr style="margin: 10px 0;">
                    {% for contact in contacts %}
                    <div style="margin: 8px 0;">
                        <label>
                            <input type="checkbox" name="contacts[]" value="{{ contact.nom }}" class="contact-checkbox">
                            <strong>{{ contact.nom }}</strong> - 
                            <span style="font-size: 0.9em; color: #666;">
                                {{ contact.email }} | {{ contact.telephone }}
                            </span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <small id="selectedCount" style="color: #666;">0 patient(s) s√©lectionn√©(s)</small>
            </div>

            <!-- Sujet (Email seulement) -->
            <div class="form-group" id="sujetGroup" style="display: none;">
                <label for="sujet">Sujet: *</label>
                <input type="text" id="sujet" name="sujet">
            </div>

            <!-- Message -->
            <div class="form-group">
                <label for="message">Message: *</label>
                <textarea id="message" name="message" rows="10" required></textarea>
            </div>

            <!-- Templates sugg√©r√©s -->
            <div class="form-group">
                <label>Templates sugg√©r√©s (cliquez pour ins√©rer):</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                    {% for template_key, template_data in templates.items() %}
                    <button type="button" class="btn" onclick="insertTemplate('{{ template_key }}')">
                        {{ template_data.sujet }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h4>‚ö†Ô∏è Attention - Envoi Group√©</h4>
                <ul style="margin-left: 20px; line-height: 1.8;">
                    <li>V√©rifiez bien votre message avant l'envoi</li>
                    <li>L'envoi group√© peut prendre du temps selon le nombre de destinataires</li>
                    <li>Les √©checs d'envoi individuels seront signal√©s dans le rapport</li>
                    <li>Respectez les limites d'envoi configur√©es pour √©viter le blocage</li>
                </ul>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary" onclick="return confirm('Confirmer l\'envoi √† tous les patients s√©lectionn√©s ?')">
                    üì§ Envoyer
                </button>
                <a href="{{ url_for('communications') }}" class="btn">Annuler</a>
            </div>
        </form>
    </div>
</div>

<script>
var templates = {{ templates|tojson }};

function updateForm() {
    var type = document.getElementById('type').value;
    var sujetGroup = document.getElementById('sujetGroup');
    var sujetInput = document.getElementById('sujet');
    
    if (type === 'email') {
        sujetGroup.style.display = 'block';
        sujetInput.required = true;
    } else {
        sujetGroup.style.display = 'none';
        sujetInput.required = false;
    }
}

function toggleAllContacts() {
    var selectAll = document.getElementById('selectAll');
    var checkboxes = document.querySelectorAll('.contact-checkbox');
    
    checkboxes.forEach(function(checkbox) {
        checkbox.checked = selectAll.checked;
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    var checkboxes = document.querySelectorAll('.contact-checkbox:checked');
    document.getElementById('selectedCount').textContent = checkboxes.length + ' patient(s) s√©lectionn√©(s)';
}

// Mettre √† jour le compteur quand on coche/d√©coche
document.addEventListener('DOMContentLoaded', function() {
    var checkboxes = document.querySelectorAll('.contact-checkbox');
    checkboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', updateSelectedCount);
    });
});

function insertTemplate(templateKey) {
    var template = templates[templateKey];
    if (template) {
        var type = document.getElementById('type').value;
        
        if (type === 'email') {
            document.getElementById('sujet').value = template.sujet;
            document.getElementById('message').value = template.corps;
        } else {
            document.getElementById('message').value = template.corps;
        }
    }
}
</script>
{% endblock %}