{% extends "base.html" %}

{% block title %}Envoyer WhatsApp - Cabinet M√©dical{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>üí¨ Envoyer un Message WhatsApp</h1>
        <p>Envoyer un message √† {{ contact.nom }}</p>
    </div>

    <div class="actions">
        <a href="{{ url_for('contacts') }}" class="btn">‚Üê Retour aux Contacts</a>
    </div>

    <div class="form-container">
        <form method="POST" id="whatsappForm">
            <!-- Informations du destinataire -->
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h3>Destinataire</h3>
                <p><strong>Nom:</strong> {{ contact.nom }}</p>
                <p><strong>T√©l√©phone:</strong> {{ contact.telephone }}</p>
            </div>

            <!-- Choix: Template ou Message personnalis√© -->
            <div class="form-group">
                <label>Mode d'envoi:</label>
                <select name="mode" id="modeSelect" onchange="toggleMode()">
                    <option value="custom">Message personnalis√©</option>
                    <option value="template">Utiliser un template</option>
                </select>
            </div>

            <!-- Section Message personnalis√© -->
            <div id="customSection">
                <div class="form-group">
                    <label for="message">Message: *</label>
                    <textarea id="message" name="message" rows="10" required 
                              placeholder="√âcrivez votre message ici..."></textarea>
                    <small>Limite recommand√©e: 1600 caract√®res</small>
                </div>
            </div>

            <!-- Section Template -->
            <div id="templateSection" style="display: none;">
                <div class="form-group">
                    <label for="template">Choisir un template:</label>
                    <select name="template" id="templateSelect" onchange="previewTemplate()">
                        <option value="">-- S√©lectionner --</option>
                        <option value="rappel_rdv">Rappel de rendez-vous</option>
                        <option value="resultats">R√©sultats d'examens</option>
                        <option value="confirmation">Confirmation de rendez-vous</option>
                        <option value="information">Information importante</option>
                    </select>
                </div>

                <!-- Variables pour les templates -->
                <div id="templateVars" style="display: none;">
                    <div class="form-group">
                        <label for="date">Date du rendez-vous:</label>
                        <input type="date" id="date" name="date">
                    </div>

                    <div class="form-group">
                        <label for="heure">Heure du rendez-vous:</label>
                        <input type="time" id="heure" name="heure">
                    </div>

                    <div class="form-group">
                        <label for="custom_message">Message personnalis√© (optionnel):</label>
                        <textarea id="custom_message" name="custom_message" rows="4"></textarea>
                    </div>
                </div>

                <!-- Aper√ßu du template -->
                <div id="templatePreview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; display: none;">
                    <h4>Aper√ßu WhatsApp:</h4>
                    <div id="previewContent" style="white-space: pre-wrap; font-family: Arial, sans-serif;"></div>
                </div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary" style="background: #25D366;">üí¨ Envoyer sur WhatsApp</button>
                <a href="{{ url_for('contacts') }}" class="btn">Annuler</a>
            </div>
        </form>
    </div>
</div>

<script>
function toggleMode() {
    var mode = document.getElementById('modeSelect').value;
    var customSection = document.getElementById('customSection');
    var templateSection = document.getElementById('templateSection');
    
    if (mode === 'custom') {
        customSection.style.display = 'block';
        templateSection.style.display = 'none';
        document.getElementById('message').required = true;
    } else {
        customSection.style.display = 'none';
        templateSection.style.display = 'block';
        document.getElementById('message').required = false;
    }
}

function previewTemplate() {
    var template = document.getElementById('templateSelect').value;
    var templateVars = document.getElementById('templateVars');
    var preview = document.getElementById('templatePreview');
    
    if (template) {
        templateVars.style.display = 'block';
        preview.style.display = 'block';
        
        // Afficher un aper√ßu basique
        var templates = {{ templates|tojson }};
        var selectedTemplate = templates[template];
        if (selectedTemplate) {
            var previewText = selectedTemplate.corps;
            previewText = previewText.replace('{nom}', '{{ contact.nom }}');
            previewText = previewText.replace('{cabinet_name}', 'Cabinet M√©dical');
            previewText = previewText.replace('{date}', '[DATE]');
            previewText = previewText.replace('{heure}', '[HEURE]');
            previewText = previewText.replace('{message}', '[VOTRE MESSAGE]');
            document.getElementById('previewContent').textContent = previewText;
        }
    } else {
        templateVars.style.display = 'none';
        preview.style.display = 'none';
    }
}
</script>
{% endblock %}